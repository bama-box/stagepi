name: Backend Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/backend/**'
      - '.github/workflows/backend-tests.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/backend/**'
      - '.github/workflows/backend-tests.yml'

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up QEMU for ARM64 emulation
      uses: docker/setup-qemu-action@v3
      with:
        platforms: linux/arm64

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker test image
      working-directory: ./src/backend
      run: |
        docker build --platform linux/arm64 -t stagepi-test -f Dockerfile.dev .

    - name: Run linting with Ruff
      working-directory: ./src/backend
      run: |
        docker run --rm --platform linux/arm64 \
          -v "$(pwd):/app:ro" \
          -e RUFF_CACHE_DIR=/tmp/ruff \
          stagepi-test sh -c "python3 -m ruff check . && python3 -m ruff format --check ."

    - name: Run tests with pytest
      working-directory: ./src/backend
      run: |
        docker run --rm --platform linux/arm64 \
          -v "$(pwd):/app:ro" \
          stagepi-test python3 -m pytest tests/ -v --cov=. --cov-report=xml --cov-report=term-missing

    - name: Extract coverage report
      working-directory: ./src/backend
      run: |
        docker run --rm --platform linux/arm64 \
          -v "$(pwd):/app" \
          stagepi-test cp /app/coverage.xml /app/coverage.xml || true

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./src/backend/coverage.xml
        flags: backend
        name: backend-docker-arm64
        fail_ci_if_error: false

    - name: Generate coverage summary
      working-directory: ./src/backend
      run: |
        docker run --rm --platform linux/arm64 \
          -v "$(pwd):/app:ro" \
          stagepi-test python3 -m coverage report --format=markdown >> $GITHUB_STEP_SUMMARY || true

