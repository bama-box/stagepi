<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StagePi</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" xintegrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0V4LLanw2qksYuRlEzO+tcaEPQogQ0KaoGN26/zrn20ImR1DfuLWnOo7aBA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e2e8f0; /* Softer light blue-gray background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .main-wrapper {
            display: flex;
            flex-direction: column; /* Stacks top bar, app-content, and status bar vertically */
            background-color: #ffffff;
            border-radius: 16px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
            width: 100%;
            max-width: 900px;
            min-height: 550px;
            height: 90vh; /* Make main-wrapper take up most of the viewport height */
            max-height: 700px; /* Limit max height to prevent it from becoming too tall */
            overflow: hidden; /* Ensures rounded corners are respected and internal scrolling is contained */
            border: 1px solid #e2e8f0;
        }
        .top-bar {
            background-color: #1f2937; /* Dark background, similar to sidebar */
            color: #ffffff;
            padding: 15px 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-top-left-radius: 16px; /* Retain top radius for the top bar itself */
            border-top-right-radius: 16px; /* Retain top radius for the top bar itself */
            border-bottom: 1px solid #374151;
            flex-shrink: 0; /* Prevent top bar from shrinking */
            flex-wrap: wrap; /* Allow items to wrap on smaller screens */
            gap: 10px;
        }
        .top-bar-logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            font-size: 1.2rem;
        }
        .top-bar-logo img {
            height: 30px; /* Adjust logo size */
            width: auto;
            border-radius: 4px; /* Slightly rounded logo */
        }
        .top-bar-info {
            display: flex;
            align-items: center;
            gap: 20px;
            font-size: 0.9rem;
        }
        .top-bar-info span {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #d1d5db;
        }
        .top-bar-info i {
            color: #90cdf4;
        }

        .app-content {
            display: flex; /* Lays out sidebar and content-area side-by-side */
            flex-grow: 1; /* Allows this section to take up remaining vertical space */
            overflow: hidden; /* Important for containing internal scrolling */
        }
        .sidebar {
            width: 200px; /* Narrower width for sidebar */
            background-color: #1f2937; /* Darker background for sidebar */
            padding: 30px 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            border-right: 1px solid #374151; /* Subtle separator */
            flex-shrink: 0; /* Prevent sidebar from shrinking */
            overflow-y: auto; /* Allow sidebar content to scroll independently if needed */
        }
        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            border-radius: 10px;
            color: #d1d5db; /* Light gray text */
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
        }
        .sidebar-item:hover {
            background-color: #374151; /* Slightly lighter dark on hover */
            color: #e5e7eb;
        }
        .sidebar-item.active {
            background-color: #3b82f6; /* Blue 500 for active */
            color: #ffffff;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
        }
        .sidebar-item.active .sidebar-icon {
            color: #ffffff; /* Ensure icon color matches active state */
        }
        .sidebar-icon {
            font-size: 1.3rem;
            color: #9ca3af; /* Gray icon color */
            width: 24px; /* Fixed width for icon alignment */
            text-align: center;
        }
        .content-area {
            flex-grow: 1; /* Allows content area to take up remaining horizontal space */
            padding: 40px;
            display: flex;
            flex-direction: column;
            gap: 28px;
            overflow-y: auto; /* Allows content area to scroll independently */
        }
        .form-section {
            display: none; /* Hidden by default */
        }
        .form-section.active {
            display: block; /* Shown when active */
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 700;
            color: #334155;
            font-size: 1.05rem;
        }
        input[type="text"],
        select,
        input[type="range"] {
            width: 100%;
            padding: 14px;
            border: 1px solid #cbd5e1;
            border-radius: 10px;
            font-size: 1.05rem;
            color: #1e293b;
            background-color: #f8fafc;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        input[type="text"]:focus,
        select:focus,
        input[type="range"]:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.3);
        }
        input[type="range"] {
            -webkit-appearance: none;
            height: 8px;
            background: #cbd5e1;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #3b82f6;
        }
        input:focus + .slider {
            box-shadow: 0 0 1px #3b82f6;
        }
        input:checked + .slider:before {
            -webkit-transform: translateX(26px);
            -ms-transform: translateX(26px);
            transform: translateX(26px);
        }

        button {
            padding: 16px 40px; /* Increased padding for larger buttons */
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.9rem; /* Decreased font size for buttons */
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out, box-shadow 0.2s ease-in-out;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.12);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        }
        button:active {
            transform: translateY(0);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background-color: #3b82f6;
            color: #ffffff;
            border: none;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-secondary {
            background-color: #64748b;
            color: #ffffff;
            border: none;
        }
        .btn-secondary:hover {
            background-color: #475569;
        }
        .message-box {
            padding: 18px;
            border-radius: 10px;
            margin-top: 25px;
            font-weight: 500;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        }
        .message-box.show {
            opacity: 1;
        }
        .message-success {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #34d399;
        }
        .message-info {
            background-color: #e0f2fe;
            color: #1e40af;
            border: 1px solid #60a5fa;
        }
        .disclaimer {
            background-color: #fffbeb;
            color: #b45309;
            padding: 20px;
            border-radius: 10px;
            font-size: 0.95rem;
            line-height: 1.6;
            border-left: 5px solid #f59e0b;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .title {
            font-size: 2.2rem; /* Slightly smaller for section titles */
            font-weight: 800;
            color: #1a202c;
            margin-bottom: 20px;
        }
        .status-bar {
            background-color: #2d3748; /* Darker gray for status bar */
            color: #e2e8f0; /* Light text */
            padding: 15px 20px;
            border-bottom-left-radius: 16px; /* Retain bottom radius for the status bar itself */
            border-bottom-right-radius: 16px; /* Retain bottom radius for the status bar itself */
            display: flex;
            justify-content: space-around;
            align-items: center;
            font-size: 0.9rem;
            gap: 10px; /* Space between items */
            flex-wrap: wrap; /* Allow items to wrap on smaller screens */
            border-top: 1px solid #4a5568; /* Subtle top border */
            flex-shrink: 0; /* Prevent status bar from shrinking */
        }
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .status-item i {
            color: #90cdf4; /* Light blue icon */
        }
        .status-disclaimer {
            font-size: 0.75rem;
            color: #a0aec0;
            text-align: center;
            width: 100%;
            margin-top: 5px;
        }
        .connected-clients-list {
            background-color: #f8fafc;
            border: 1px solid #cbd5e1;
            border-radius: 10px;
            padding: 15px;
            min-height: 100px; /* Ensure it has some height */
            overflow-y: auto; /* Scroll if many clients */
        }
        .client-item {
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.95rem;
            color: #334155;
        }
        .client-item:last-child {
            border-bottom: none;
        }
        .client-item span {
            font-weight: 500;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            body {
                padding: 10px; /* Reduce body padding on small screens */
            }
            .main-wrapper {
                flex-direction: column;
                max-width: 100%;
                min-height: auto;
                height: auto; /* Allow height to adjust on small screens */
                max-height: none; /* Remove max height constraint */
            }
            .top-bar {
                flex-direction: column;
                align-items: flex-start;
                padding: 15px;
                border-radius: 16px 16px 0 0; /* Ensure top bar keeps its rounded corners */
            }
            .top-bar-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
                margin-top: 10px;
            }
            .app-content {
                flex-direction: column; /* Stack sidebar and content vertically on small screens */
            }
            .sidebar {
                width: 100%; /* Full width for sidebar on small screens */
                flex-direction: row; /* Horizontal menu on small screens */
                flex-wrap: wrap;
                justify-content: center;
                border-right: none;
                border-bottom: 1px solid #374151;
                padding: 20px 10px;
                border-radius: 0; /* Remove fixed radii */
            }
            .sidebar-item {
                flex-grow: 1; /* Allow items to grow */
                justify-content: center; /* Center text and icon */
                padding: 10px 12px;
                font-size: 0.9rem;
            }
            .sidebar-item span {
                display: none; /* Hide text on small screens if too cramped */
            }
            .sidebar-item .sidebar-icon {
                margin-right: 0; /* No margin if text is hidden */
            }
            .content-area {
                padding: 25px;
            }
            .title {
                font-size: 1.8rem;
            }
            .status-bar {
                flex-direction: column; /* Stack status items vertically on small screens */
                padding: 10px;
                font-size: 0.8rem;
                border-radius: 0 0 16px 16px; /* Ensure bottom bar keeps its rounded corners */
            }
            .status-item {
                justify-content: center;
            }
            /* Adjust button font size for smaller screens if needed */
            button {
                font-size: 0.85rem; /* Slightly smaller font for buttons on small screens */
                padding: 14px 30px;
            }
        }
    </style>
</head>
<body>
    <div class="main-wrapper">
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="top-bar-logo">
                <img id="appLogo" src="https://placehold.co/40x40/3b82f6/ffffff?text=BB" alt="Raspberry Pi Logo" onerror="this.onerror=null;this.src='https://placehold.co/40x40/3b82f6/ffffff?text=Logo';">
                <span>StagePi</span>
            </div>
            <div class="top-bar-info">
                <span><i class="fas fa-desktop"></i> <span id="topBarHostname">--</span></span>
                <span><i class="fas fa-fingerprint"></i> ID: <span id="topBarUniqueId">--</span></span>
            </div>
        </div>

        <div class="app-content">
            <div class="sidebar">
                <div class="sidebar-item active" data-section="airplay">
                    <i class="fas fa-music sidebar-icon"></i>
                    <span>AirPlay</span>
                </div>
                <div class="sidebar-item" data-section="network">
                    <i class="fas fa-network-wired sidebar-icon"></i>
                    <span>Network</span>
                </div>
                <div class="sidebar-item" data-section="wifi">
                    <i class="fas fa-wifi sidebar-icon"></i>
                    <span>Wi-Fi</span>
                </div>
                <div class="sidebar-item" data-section="volume">
                    <i class="fas fa-volume-up sidebar-icon"></i>
                    <span>Volume</span>
                </div>
                <div class="sidebar-item" data-section="aes67">
                    <i class="fas fa-broadcast-tower sidebar-icon"></i>
                    <span>AES67</span>
                </div>
            </div>

            <div class="content-area">
                <h1 class="title text-center">Shairport-Sync Configurator</h1>

                <!-- AirPlay Section (Existing Shairport-Sync Config) -->
                <div id="airplay-section" class="form-section active">
                    <!-- Current Media Section -->
                    <div class="mt-10 mb-8" id="currentMediaSection">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Now Playing</h3>
                        <div class="flex items-center gap-6">
                            <img id="mediaArtwork" src="" alt="Artwork" class="rounded-lg shadow-md" style="width: 96px; height: 96px; object-fit: cover; background: #f3f4f6;" onerror="this.src='https://placehold.co/96x96?text=No+Art'">
                            <div>
                                <div class="font-semibold text-lg text-gray-900" id="mediaTitle">--</div>
                                <div class="text-gray-700" id="mediaArtist">--</div>
                                <div class="text-gray-500 text-sm" id="mediaAlbum">--</div>
                            </div>
                        </div>
                    </div>
                    
                    <form id="airplayConfigForm" class="space-y-8">
                        <div class="form-group">
                            <label for="deviceName">Device Name:</label>
                            <input type="text" id="deviceName" name="deviceName" placeholder="e.g., My Raspberry Pi Speaker">
                        </div>

                        <div class="form-group">
                            <label for="volumeControl">Volume Control:</label>
                            <select id="volumeControl" name="volumeControl">
                                <option value="software">Software Volume</option>
                                <option value="hardware">Hardware Volume</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="audioOutput">Audio Output:</label>
                            <select id="audioOutput" name="audioOutput">
                                <option value="auto">Auto (Default)</option>
                                <option value="analog">Analog (3.5mm Jack)</option>
                                <option value="hdmi">HDMI</option>
                                <option value="usb">USB DAC</option>
                            </select>
                        </div>

                        <div class="flex flex-col sm:flex-row justify-center gap-6 mt-8">
                            <button type="button" id="saveAirplayConfigBtn" class="btn-primary">Save AirPlay Config</button>
                            <button type="button" id="restartServiceBtn" class="btn-secondary">Restart Shairport-Sync</button>
                        </div>
                    </form>

                    <div class="mt-10">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Connected Clients</h3>
                        <div id="connectedClientsList" class="connected-clients-list">
                            <!-- Clients will be dynamically loaded here -->
                            <p class="text-gray-500 text-center py-4">No clients connected.</p>
                        </div>
                        <div class="flex justify-center mt-6">
                            <button type="button" id="refreshClientsBtn" class="btn-primary">Refresh Clients</button>
                        </div>
                    </div>
                </div>

                <!-- Network Section -->
                <div id="network-section" class="form-section">
                    <form class="space-y-8">
                        <div class="form-group flex items-center justify-between">
                            <label for="ethernetEnabled" class="mb-0">Ethernet Enabled:</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="ethernetEnabled" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="ipAddress">IP Address (Read-only):</label>
                            <input type="text" id="ipAddress" name="ipAddress" value="192.168.1.100" readonly class="bg-gray-100 cursor-not-allowed">
                        </div>
                        <div class="form-group">
                            <label for="gateway">Gateway (Read-only):</label>
                            <input type="text" id="gateway" name="gateway" value="192.168.1.1" readonly class="bg-gray-100 cursor-not-allowed">
                        </div>
                        <div class="flex flex-col sm:flex-row justify-center gap-6 mt-8">
                            <button type="button" class="btn-primary">Apply Network Settings</button>
                        </div>
                    </form>
                </div>

                <!-- Wi-Fi Section -->
                <div id="wifi-section" class="form-section">                
                    <form class="space-y-8">
                        <div class="form-group flex items-center justify-between">
                            <label for="wifiEnabled" class="mb-0">Wi-Fi Enabled:</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="wifiEnabled" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="ssid">Wi-Fi Network (SSID):</label>
                            <input type="text" id="ssid" name="ssid" placeholder="e.g., MyHomeNetwork">
                        </div>
                        <div class="form-group">
                            <label for="password">Wi-Fi Password:</label>
                            <input type="password" id="password" name="password" placeholder="Enter password">
                        </div>
                        <div class="flex flex-col sm:flex-row justify-center gap-6 mt-8">
                            <button type="button" class="btn-primary">Connect to Wi-Fi</button>
                        </div>
                    </form>
                </div>

                <!-- Volume Section -->
                <div id="volume-section" class="form-section">
                    <form class="space-y-8">
                        <div class="form-group">
                            <label for="masterVolume">Master Volume: <span id="volumeValue">50</span>%</label>
                            <input type="range" id="masterVolume" name="masterVolume" min="0" max="100" value="50">
                        </div>
                        <div class="flex flex-col sm:flex-row justify-center gap-6 mt-8">
                            <button type="button" class="btn-primary">Set Volume</button>
                        </div>
                    </form>
                </div>

                <!-- AES67 Section -->
                <div id="aes67-section" class="form-section">
                    <form class="space-y-8">
                        <div class="form-group flex items-center justify-between">
                            <label for="aes67Enabled" class="mb-0">Enable AES67:</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="aes67Enabled">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="form-group">
                            <p class="text-gray-600 text-sm">
                                AES67 is a standard for high-performance audio-over-IP interoperability.
                                Enabling this may require specific network configurations and compatible devices.
                            </p>
                        </div>
                        <div class="flex flex-col sm:flex-row justify-center gap-6 mt-8">
                            <button type="button" class="btn-primary">Apply AES67 Settings</button>
                        </div>
                    </form>
                </div>

                <div id="messageBox" class="message-box"></div>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-item">
                <i class="fas fa-microchip"></i>
                <span>CPU: <span id="cpuUsage">--</span>%</span>
            </div>
            <div class="status-item">
                <i class="fas fa-memory"></i>
                <span>RAM: <span id="ramUsage">--</span>%</span>
            </div>
            <div class="status-item">
                <i class="fas fa-server"></i>
                <span>Hostname: <span id="hostname">--</span></span>
            </div>
            <div class="status-item">
                <i class="fas fa-temperature-high"></i>
                <span>Temp: <span id="cpuTemp">--</span>°C</span>
            </div>
        </div>
    </div>

    <script>
        // Mock Shairport-Sync configuration (will be fetched from backend)
        let shairportConfig = {
            deviceName: "Loading...",
            volumeControl: "software",
            audioOutput: "auto"
        };

        // Mock Network/Wi-Fi/Volume/AES67 states (will be fetched from backend)
        let networkConfig = {
            ethernetEnabled: true,
            ipAddress: "Loading...",
            gateway: "Loading..."
        };
        let wifiConfig = {
            wifiEnabled: true,
            ssid: "",
            password: ""
        };
        let volumeState = {
            masterVolume: 50
        };
        let aes67Config = {
            aes67Enabled: false
        };

        // Mock System Status Data (will be fetched from backend)
        let systemStatus = {
            cpuUsage: '--',
            ramUsage: '--',
            hostname: '--',
            cpuTemp: '--'
        };

        // Mock Top Bar Data (will be fetched from backend for dynamic parts)
        let topBarData = {
            logoUrl: "https://placehold.co/40x40/3b82f6/ffffff?text=RPi", // Placeholder for Raspberry Pi logo
            hostname: "--",
            uniqueId: "--"
        };

        // Mock Connected Clients Data (will be fetched from backend)
        let connectedClients = [];

        // Get elements
        const sidebarItems = document.querySelectorAll('.sidebar-item');
        const formSections = document.querySelectorAll('.form-section');
        const messageBox = document.getElementById('messageBox');

        // Top Bar elements
        const appLogo = document.getElementById('appLogo');
        const topBarHostname = document.getElementById('topBarHostname');
        const topBarUniqueId = document.getElementById('topBarUniqueId');

        // AirPlay elements
        const deviceNameInput = document.getElementById('deviceName');
        const volumeControlSelect = document.getElementById('volumeControl');
        const audioOutputSelect = document.getElementById('audioOutput');
        const saveAirplayConfigBtn = document.getElementById('saveAirplayConfigBtn');
        const restartServiceBtn = document.getElementById('restartServiceBtn');
        const connectedClientsList = document.getElementById('connectedClientsList');
        const refreshClientsBtn = document.getElementById('refreshClientsBtn');
        // New: Media elements
        const mediaArtwork = document.getElementById('mediaArtwork');
        const mediaTitle = document.getElementById('mediaTitle');
        const mediaArtist = document.getElementById('mediaArtist');
        const mediaAlbum = document.getElementById('mediaAlbum');

        // Network elements
        const ethernetEnabledToggle = document.getElementById('ethernetEnabled');
        const ipAddressInput = document.getElementById('ipAddress');
        const gatewayInput = document.getElementById('gateway');

        // Wi-Fi elements
        const wifiEnabledToggle = document = document.getElementById('wifiEnabled');
        const ssidInput = document.getElementById('ssid');
        const passwordInput = document.getElementById('password');

        // Volume elements
        const masterVolumeSlider = document.getElementById('masterVolume');
        const volumeValueSpan = document.getElementById('volumeValue');

        // AES67 elements
        const aes67EnabledToggle = document.getElementById('aes67Enabled');

        // Status Bar elements
        const cpuUsageSpan = document.getElementById('cpuUsage');
        const ramUsageSpan = document.getElementById('ramUsage');
        const hostnameSpan = document.getElementById('hostname');
        const cpuTempSpan = document.getElementById('cpuTemp');


        /**
         * Fetches initial configuration and status from the backend.
         */
        async function fetchInitialData() {
            try {
                // Fetch system status
                const statusResponse = await fetch('/api/status');
                const statusData = await statusResponse.json();
                systemStatus = statusData;
                topBarData.hostname = statusData.hostname; // Update top bar hostname from real data
                updateStatusBar(); // Update status bar with fetched data

                // Fetch AirPlay config
                const airplayConfigResponse = await fetch('/api/airplay/config'); // New endpoint
                const airplayConfigData = await airplayConfigResponse.json();
                shairportConfig = airplayConfigData;
                deviceNameInput.value = shairportConfig.deviceName;
                volumeControlSelect.value = shairportConfig.volumeControl;
                audioOutputSelect.value = shairportConfig.audioOutput;

                // Fetch connected clients
                const clientsResponse = await fetch('/api/airplay/clients');
                const clientsData = await clientsResponse.json();
                connectedClients = clientsData.clients;
                console.log(clientsData)
                renderConnectedClient();

                // You would add fetches for network, wifi, volume, aes67 settings here
                // For now, load mock data for those if not fetched
                ethernetEnabledToggle.checked = networkConfig.ethernetEnabled;
                ipAddressInput.value = networkConfig.ipAddress;
                gatewayInput.value = networkConfig.gateway;
                wifiEnabledToggle.checked = wifiConfig.wifiEnabled;
                ssidInput.value = wifiConfig.ssid;
                passwordInput.value = wifiConfig.password;
                masterVolumeSlider.value = volumeState.masterVolume;
                volumeValueSpan.textContent = volumeState.masterVolume;
                aes67EnabledToggle.checked = aes67Config.aes67Enabled;

            } catch (error) {
                console.error("Error fetching initial data:", error);
                showMessage("Failed to load initial data from backend.", "error");
            }
        }


        /**
         * Renders the list of connected AirPlay clients.
         */
        function renderConnectedClient() {
            connectedClientsList.innerHTML = ''; // Clear existing list
            if (connectedClients.length === 0) {
                connectedClientsList.innerHTML = '<p class="text-gray-500 text-center py-4">No clients connected.</p>';
            } else {
                const clientItem = document.createElement('div');
                clientItem.classList.add('client-item');
                clientItem.innerHTML = `
                     <span class="text-gray-600">${connectedClients}</span>`;
                connectedClientsList.appendChild(clientItem);
            }
        }

        /**
         * Fetches and displays the latest list of connected clients from the backend.
         */
        refreshClientsBtn.addEventListener('click', async () => {
            showMessage("Refreshing client list...", "info");
            try {
                const response = await fetch('/api/airplay/clients');
                const data = await response.json();
                console.log(data);
                if (data.success) {
                    connectedClients = data.clients;
                    renderConnectedClient();
                    showMessage("Client list refreshed!", "success");
                } else {
                    showMessage(`Failed to refresh clients: ${data.message || 'Unknown error'}`, "error");
                }
            } catch (error) {
                console.error('Error refreshing clients:', error);
                showMessage("An error occurred while refreshing clients.", "error");
            }
        });

        /**
         * Fetches and displays the current AirPlay media metadata and artwork.
         */
        async function fetchAndDisplayMedia() {
            try {
                const response = await fetch('/api/airplay/media');
                const data = await response.json();
                mediaTitle.textContent = data.title || '--';
                mediaArtist.textContent = data.artist || '--';
                mediaAlbum.textContent = data.album || '--';

                if (data.artwork_url && data.artwork_url.startsWith('file://')) {
                    mediaArtwork.src = data.artwork_url;
                } else if (data.artwork_url) {
                    mediaArtwork.src = data.artwork_url;
                } else {
                    mediaArtwork.src = 'https://placehold.co/96x96?text=No+Art';
                }
                console.log(mediaArtwork.src);
            } catch (error) {
                mediaTitle.textContent = '--';
                mediaArtist.textContent = '--';
                mediaAlbum.textContent = '--';
                mediaArtwork.src = 'https://placehold.co/96x96?text=No+Art';
            }
        }

        /**
         * Updates the status bar with system data.
         */
        function updateStatusBar() {
            cpuUsageSpan.textContent = systemStatus.cpuUsage;
            ramUsageSpan.textContent = systemStatus.ramUsage;
            hostnameSpan.textContent = systemStatus.hostname;
            cpuTempSpan.textContent = systemStatus.cpuTemp;
            topBarHostname.textContent = topBarData.hostname; // Update top bar hostname
            topBarUniqueId.textContent = topBarData.uniqueId; // Update top bar unique ID
        }

        /**
         * Displays a message in the message box.
         * @param {string} message - The message to display.
         * @param {string} type - The type of message ('success' or 'info').
         */
        function showMessage(message, type) {
            messageBox.textContent = message;
            messageBox.className = 'message-box show'; // Reset classes and show
            if (type === 'success') {
                messageBox.classList.add('message-success');
            } else if (type === 'info') {
                messageBox.classList.add('message-info');
            } else if (type === 'error') { // Added error style
                messageBox.classList.add('bg-red-100', 'text-red-800', 'border-red-400');
            }
            // Hide message after 3 seconds
            setTimeout(() => {
                messageBox.classList.remove('show', 'message-success', 'message-info', 'bg-red-100', 'text-red-800', 'border-red-400');
            }, 3000);
        }

        /**
         * Handles saving the AirPlay configuration via backend API.
         */
        saveAirplayConfigBtn.addEventListener('click', async () => {
            const newConfig = {
                deviceName: deviceNameInput.value,
                volumeControl: volumeControlSelect.value,
                audioOutput: audioOutputSelect.value
            };

            showMessage("Saving AirPlay configuration...", "info");
            try {
                const response = await fetch('/api/airplay/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(newConfig),
                });
                const data = await response.json();
                if (data.success) {
                    shairportConfig = newConfig; // Update local mock on success
                    showMessage(data.message, "success");
                } else {
                    showMessage(`Failed to save config: ${data.message || 'Unknown error'}`, "error");
                }
            } catch (error) {
                console.error('Error saving configuration:', error);
                showMessage("An error occurred while saving configuration.", "error");
            }
        });

        /**
         * Handles restarting the Shairport-Sync service via backend API.
         */
        restartServiceBtn.addEventListener('click', async () => {
            showMessage("Restarting Shairport-Sync service...", "info");
            try {
                const response = await fetch('/api/airplay/restart', {
                    method: 'POST',
                });
                const data = await response.json();
                if (data.success) {
                    showMessage(data.message, "success");
                } else {
                    showMessage(`Failed to restart service: ${data.message || 'Unknown error'}`, "error");
                }
            } catch (error) {
                console.error('Error restarting service:', error);
                showMessage("An error occurred while restarting service.", "error");
            }
        });

        /**
         * Updates the volume value display as the slider is moved.
         */
        masterVolumeSlider.addEventListener('input', () => {
            volumeValueSpan.textContent = masterVolumeSlider.value;
            volumeState.masterVolume = parseInt(masterVolumeSlider.value); // Update mock state
        });

        /**
         * Handles navigation between sections.
         */
        sidebarItems.forEach(item => {
            item.addEventListener('click', () => {
                // Remove active class from all sidebar items
                sidebarItems.forEach(i => i.classList.remove('active'));
                // Add active class to the clicked item
                item.classList.add('active');

                // Hide all form sections
                formSections.forEach(section => section.classList.remove('active'));

                // Show the corresponding section
                const sectionId = item.dataset.section + '-section';
                document.getElementById(sectionId).classList.add('active');

                // Update the main title based on the active section
                const sectionTitle = item.querySelector('span').textContent + ' Settings';
                document.querySelector('.title').textContent = sectionTitle;
            });
        });

        // Initialize the app by fetching data from backend
        document.addEventListener('DOMContentLoaded', () => {
            fetchInitialData();
            fetchAndDisplayMedia(); // Fetch media info on load
            // Set initial title to AirPlay Settings
            document.querySelector('.title').textContent = "AirPlay Settings";
            // Update top bar hostname and ID with initial mock values until real data loads
            topBarHostname.textContent = topBarData.hostname;
            topBarUniqueId.textContent = topBarData.uniqueId;
        });

        // Periodically refresh system status (e.g., every 5 seconds)
        setInterval(async () => {
            try {
                const statusResponse = await fetch('/api/status');
                const statusData = await statusResponse.json();
                systemStatus = statusData;
                topBarData.hostname = statusData.hostname; // Keep top bar hostname in sync
                updateStatusBar();
                fetchAndDisplayMedia(); // Refresh media info every 5 seconds
            } catch (error) {
                console.warn("Could not fetch real-time status:", error);
                // Optionally show a small warning in the status bar if connection is lost
            }
        }, 5000); // Refresh every 5 seconds
    </script>
</body>
</html>
