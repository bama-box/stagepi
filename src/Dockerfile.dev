# Dockerfile for StagePi development and testing environment
# Use Debian Bookworm to match Raspberry Pi OS

# syntax=docker/dockerfile:1
FROM debian:bookworm-slim

# Set environment variables
ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1
ENV PYTHONPATH=/app

# Copy and install the pre-built stagepi package
# Use the latest build from the build directory
COPY stagepi-latest.deb /tmp/stagepi.deb

# Install the stagepi package
RUN apt-get update && \
    apt install /tmp/stagepi.deb -y && \
    rm -rf /var/lib/apt/lists/*

# Create log directory and supervisor streams config directory
RUN mkdir -p /var/log/supervisor /etc/supervisor/conf.d/streams && \
    echo "[include]" >> /etc/supervisor/supervisord.conf && \
    echo "files = /etc/supervisor/conf.d/*.conf /etc/supervisor/conf.d/streams/*.conf" >> /etc/supervisor/supervisord.conf

# Expose the backend port
EXPOSE 8000

# Run supervisor as entrypoint
ENTRYPOINT ["/usr/bin/supervisord", "-n", "-c", "/etc/supervisor/supervisord.conf"]
