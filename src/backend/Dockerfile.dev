# Dockerfile for StagePi ARM development and testing environment
# Use Debian Bookworm ARM64 to match Raspberry Pi OS

# syntax=docker/dockerfile:1
FROM debian:bookworm-slim

# Set environment variables
ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1

# Install system dependencies matching Raspberry Pi (from DEBIAN/control)
RUN apt-get update && apt-get install -y --no-install-recommends \
    # Python runtime
    python3 \
    python3-pip \
    # Python system packages (matching DEBIAN/control)
    python3-netifaces \
    python3-psutil \
    python3-libconf \
    python3-pydbus \
    python3-bleak \
    python3-bluez \
    python3-dbus-next \
    python3-fastapi \
    python3-pydantic \
    python3-gi \
    uvicorn \
    # GStreamer packages
    gstreamer1.0-tools \
    gstreamer1.0-plugins-base \
    gstreamer1.0-plugins-good \
    gstreamer1.0-plugins-bad \
    gstreamer1.0-plugins-ugly \
    gstreamer1.0-alsa \
    gstreamer1.0-libav \
    gir1.2-gstreamer-1.0 \
    # Development and testing tools
    python3-pytest \
    python3-pytest-cov \
    python3-pytest-asyncio \
    python3-pytest-mock \
    python3-httpx \
    # Utilities
    git \
    curl \
    vim \
    && rm -rf /var/lib/apt/lists/* \
    # Install ruff via pip (not available as Debian package in Bookworm)
    && python3 -m pip install --break-system-packages ruff==0.1.9

# Set working directory
WORKDIR /app

# Copy backend source code (will be overridden by volume mount)
COPY . /app

# Default command
CMD ["/bin/bash"]
